apiVersion: karpenter.k8s.aws/v1
kind: EC2NodeClass
metadata:
  name: dynamic-disk-volume-nc
spec:
  amiFamily: Bottlerocket
  amiSelectorTerms:
  - alias: bottlerocket@v1.43.0 # Bottlerocket
  role: "<<KARPENTER_NODE_IAM_ROLE_NAME>>"
  securityGroupSelectorTerms:
  - tags:
      karpenter.sh/discovery: "<<CLUSTER_NAME>>"
  subnetSelectorTerms:
  - tags:
      karpenter.sh/discovery: "<<CLUSTER_NAME>>"
  metadataOptions:
    httpEndpoint: enabled
    httpTokens: required
    httpPutResponseHopLimit: 1
  blockDeviceMappings:
    # Root device
    - deviceName: /dev/xvda
      ebs:
        volumeSize: 4Gi
        volumeType: gp3
        encrypted: true
        deleteOnTermination: true
    # Data device: Container resources such as images and logs
    - deviceName: /dev/xvdb
      ebs:
        volumeSize: 20Gi
        volumeType: gp3
        encrypted: true
        deleteOnTermination: true
  userData: |
    [settings.bootstrap-containers.ebsresize]
    mode = "once"
    user-data = "IyEvYmluL2Jhc2gKc2V0IC1lCgpnZXRfaW1kc190b2tlbigpIHsKICAgIGN1cmwgLVggUFVUICJodHRwOi8vMTY5LjI1NC4xNjkuMjU0L2xhdGVzdC9hcGkvdG9rZW4iIFwKICAgICAgICAtSCAiWC1hd3MtZWMyLW1ldGFkYXRhLXRva2VuLXR0bC1zZWNvbmRzOiAyMTYwMCIgXAogICAgICAgIC0tbWF4LXRpbWUgMTAgLS1yZXRyeSAzCn0KCmdldF9tZXRhZGF0YSgpIHsKICAgIGxvY2FsIHBhdGg9JDEKICAgIGxvY2FsIHRva2VuPSQyCiAgICBjdXJsIC1IICJYLWF3cy1lYzItbWV0YWRhdGEtdG9rZW46ICR0b2tlbiIgXAogICAgICAgICJodHRwOi8vMTY5LjI1NC4xNjkuMjU0L2xhdGVzdC9tZXRhLWRhdGEvJHBhdGgiIFwKICAgICAgICAtLW1heC10aW1lIDEwIC0tcmV0cnkgMwp9CgpkZXRlY3Rfb3MoKSB7CiAgICBpZiBbIC1mIC9ldGMvYm90dGxlcm9ja2V0LXJlbGVhc2UgXTsgdGhlbgogICAgICAgIGVjaG8gImJvdHRsZXJvY2tldCIKICAgIGVsaWYgWyAtZiAvZXRjL29zLXJlbGVhc2UgXSAmJiBncmVwIC1xICJBbWF6b24gTGludXgiIC9ldGMvb3MtcmVsZWFzZTsgdGhlbgogICAgICAgIGVjaG8gImFsMjAyMyIKICAgIGZpCn0KCmdldF90YXJnZXRfc2l6ZV9ieV9zdWZmaXgoKSB7CiAgICBsb2NhbCBpbnN0YW5jZV90eXBlPSQxCiAgICBsb2NhbCBzaXplX3N1ZmZpeD0kKGVjaG8gJGluc3RhbmNlX3R5cGUgfCBzZWQgJ3MvLipcLi8vJykKCiAgICBjYXNlICRzaXplX3N1ZmZpeCBpbgogICAgICAgIG5hbm8pIGVjaG8gMjAgOzsKICAgICAgICBtaWNybykgZWNobyAzMCA7OwogICAgICAgIHNtYWxsKSBlY2hvIDQwIDs7CiAgICAgICAgbWVkaXVtKSBlY2hvIDYwIDs7CiAgICAgICAgbGFyZ2UpIGVjaG8gMTAwIDs7CiAgICAgICAgeGxhcmdlKSBlY2hvIDIwMCA7OwogICAgICAgIDJ4bGFyZ2UpIGVjaG8gMzAwIDs7CiAgICAgICAgM3hsYXJnZSkgZWNobyA0MDAgOzsKICAgICAgICA0eGxhcmdlKSBlY2hvIDUwMCA7OwogICAgICAgIDZ4bGFyZ2UpIGVjaG8gNjAwIDs7CiAgICAgICAgOHhsYXJnZXw5eGxhcmdlKSBlY2hvIDgwMCA7OwogICAgICAgIDEyeGxhcmdlKSBlY2hvIDEwMDAgOzsKICAgICAgICAxNnhsYXJnZXwxOHhsYXJnZSkgZWNobyAxMjAwIDs7CiAgICAgICAgMjR4bGFyZ2UpIGVjaG8gMTUwMCA7OwogICAgICAgIDMyeGxhcmdlfDQ4eGxhcmdlfDU2eGxhcmdlfDExMnhsYXJnZSkgZWNobyAyMDAwIDs7CiAgICAgICAgbWV0YWwpIGVjaG8gMTAwMCA7OwogICAgICAgICopIGVjaG8gMTAwIDs7CiAgICBlc2FjCn0KCnJlc2l6ZV9lYnNfZm9yX2luc3RhbmNlKCkgewogICAgbG9jYWwgb3NfdHlwZT0kKGRldGVjdF9vcykKICAgIGxvY2FsIGRldmljZQogICAgCiAgICBjYXNlICRvc190eXBlIGluCiAgICAgICAgYm90dGxlcm9ja2V0KQogICAgICAgICAgICBkZXZpY2U9Ii9kZXYveHZkYiIKICAgICAgICAgICAgOzsKICAgICAgICBhbDIwMjMpCiAgICAgICAgICAgIGRldmljZT0iL2Rldi94dmRhIgogICAgICAgICAgICA7OwogICAgZXNhYwoKICAgIGxvY2FsIHRva2VuPSQoZ2V0X2ltZHNfdG9rZW4pCiAgICBpZiBbIC16ICIkdG9rZW4iIF07IHRoZW4KICAgICAgICBlY2hvICJGYWlsZWQgdG8gZ2V0IElNRFN2MiB0b2tlbiIKICAgICAgICByZXR1cm4gMQogICAgZmkKCiAgICBsb2NhbCBpbnN0YW5jZV9pZD0kKGdldF9tZXRhZGF0YSAiaW5zdGFuY2UtaWQiICIkdG9rZW4iKQogICAgbG9jYWwgcmVnaW9uPSQoZ2V0X21ldGFkYXRhICJwbGFjZW1lbnQvcmVnaW9uIiAiJHRva2VuIikKICAgIGxvY2FsIGluc3RhbmNlX3R5cGU9JChnZXRfbWV0YWRhdGEgImluc3RhbmNlLXR5cGUiICIkdG9rZW4iKQoKICAgIGlmIFsgLXogIiRpbnN0YW5jZV9pZCIgXSB8fCBbIC16ICIkcmVnaW9uIiBdIHx8IFsgLXogIiRpbnN0YW5jZV90eXBlIiBdOyB0aGVuCiAgICAgICAgZWNobyAiRmFpbGVkIHRvIGdldCByZXF1aXJlZCBtZXRhZGF0YSIKICAgICAgICByZXR1cm4gMQogICAgZmkKCiAgICBsb2NhbCB0YXJnZXRfc2l6ZT0kKGdldF90YXJnZXRfc2l6ZV9ieV9zdWZmaXggIiRpbnN0YW5jZV90eXBlIikKICAgIGVjaG8gIk9TOiAkb3NfdHlwZSwgSW5zdGFuY2U6ICRpbnN0YW5jZV90eXBlIC0+IFRhcmdldDogJHt0YXJnZXRfc2l6ZX1HQiIKCiAgICBsb2NhbCB2b2x1bWVfaWQ9JChhd3MgZWMyIGRlc2NyaWJlLWluc3RhbmNlcyAtLWluc3RhbmNlLWlkcyAkaW5zdGFuY2VfaWQgXAogICAgICAgIC0tcXVlcnkgJ1Jlc2VydmF0aW9uc1swXS5JbnN0YW5jZXNbMF0uQmxvY2tEZXZpY2VNYXBwaW5nc1s/RGV2aWNlTmFtZT09YCckZGV2aWNlJ2BdLkVicy5Wb2x1bWVJZCcgXAogICAgICAgIC0tb3V0cHV0IHRleHQgLS1yZWdpb24gJHJlZ2lvbikKCiAgICBpZiBbIC16ICIkdm9sdW1lX2lkIiBdIHx8IFsgIiR2b2x1bWVfaWQiID0gIk5vbmUiIF07IHRoZW4KICAgICAgICBlY2hvICJFcnJvcjogQ291bGQgbm90IGZpbmQgdm9sdW1lIGZvciBkZXZpY2UgJGRldmljZSIKICAgICAgICByZXR1cm4gMQogICAgZmkKCiAgICBsb2NhbCBjdXJyZW50X3NpemU9JChhd3MgZWMyIGRlc2NyaWJlLXZvbHVtZXMgLS12b2x1bWUtaWRzICR2b2x1bWVfaWQgXAogICAgICAgIC0tcXVlcnkgJ1ZvbHVtZXNbMF0uU2l6ZScgLS1vdXRwdXQgdGV4dCAtLXJlZ2lvbiAkcmVnaW9uKQoKICAgIGlmIFsgIiRjdXJyZW50X3NpemUiIC1nZSAiJHRhcmdldF9zaXplIiBdOyB0aGVuCiAgICAgICAgZWNobyAiVm9sdW1lIGFscmVhZHkgY29ycmVjdCBzaXplICgke2N1cnJlbnRfc2l6ZX1HQikiCiAgICAgICAgcmV0dXJuIDAKICAgIGZpCgogICAgZWNobyAiUmVzaXppbmcgdm9sdW1lIGZyb20gJHtjdXJyZW50X3NpemV9R0IgdG8gJHt0YXJnZXRfc2l6ZX1HQiIKICAgIGF3cyBlYzIgbW9kaWZ5LXZvbHVtZSAtLXZvbHVtZS1pZCAkdm9sdW1lX2lkIC0tc2l6ZSAkdGFyZ2V0X3NpemUgLS1yZWdpb24gJHJlZ2lvbgoKICAgICMgV2FpdCBmb3IgY29tcGxldGlvbgogICAgbG9jYWwgdGltZW91dD0zMDAKICAgIGxvY2FsIGVsYXBzZWQ9MAogICAgbG9jYWwgd2FpdF90aW1lPTIKCiAgICB3aGlsZSBbICRlbGFwc2VkIC1sdCAkdGltZW91dCBdOyBkbwogICAgICAgIGxvY2FsIHN0YXRlPSQoYXdzIGVjMiBkZXNjcmliZS12b2x1bWVzLW1vZGlmaWNhdGlvbnMgLS12b2x1bWUtaWRzICR2b2x1bWVfaWQgXAogICAgICAgICAgICAtLXF1ZXJ5ICdWb2x1bWVzTW9kaWZpY2F0aW9uc1swXS5Nb2RpZmljYXRpb25TdGF0ZScgLS1vdXRwdXQgdGV4dCAtLXJlZ2lvbiAkcmVnaW9uKQoKICAgICAgICBpZiBbWyAiJHN0YXRlIiA9ICJjb21wbGV0ZWQiIHx8ICIkc3RhdGUiID0gIm9wdGltaXppbmciIF1dOyB0aGVuCiAgICAgICAgICAgIGVjaG8gIlZvbHVtZSBtb2RpZmljYXRpb24gY29tcGxldGVkIgogICAgICAgICAgICBicmVhawogICAgICAgIGVsaWYgWyAiJHN0YXRlIiA9ICJmYWlsZWQiIF07IHRoZW4KICAgICAgICAgICAgZWNobyAiVm9sdW1lIG1vZGlmaWNhdGlvbiBmYWlsZWQiCiAgICAgICAgICAgIHJldHVybiAxCiAgICAgICAgZmkKCiAgICAgICAgc2xlZXAgJHdhaXRfdGltZQogICAgICAgIGVsYXBzZWQ9JCgoZWxhcHNlZCArIHdhaXRfdGltZSkpCiAgICAgICAgd2FpdF90aW1lPSQoKHdhaXRfdGltZSAqIDIpKQogICAgICAgIFsgJHdhaXRfdGltZSAtZ3QgMzAgXSAmJiB3YWl0X3RpbWU9MzAKICAgIGRvbmUKCiAgICBpZiBbICRlbGFwc2VkIC1nZSAkdGltZW91dCBdOyB0aGVuCiAgICAgICAgZWNobyAiVGltZW91dCB3YWl0aW5nIGZvciB2b2x1bWUgbW9kaWZpY2F0aW9uIgogICAgICAgIHJldHVybiAxCiAgICBmaQoKICAgICMgT1Mtc3BlY2lmaWMgZmlsZXN5c3RlbSByZXNpemUKICAgIGlmIFsgIiRvc190eXBlIiA9ICJhbDIwMjMiIF07IHRoZW4KICAgICAgICBncm93cGFydCAkZGV2aWNlIDEgfHwgewogICAgICAgICAgICBlY2hvICJGYWlsZWQgdG8gZXh0ZW5kIHBhcnRpdGlvbiIKICAgICAgICAgICAgcmV0dXJuIDEKICAgICAgICB9CgogICAgICAgIGxvY2FsIGZzX3R5cGU9JChsc2JsayAtZiAke2RldmljZX0xIHwgdGFpbCAtMSB8IGF3ayAne3ByaW50ICQyfScpCiAgICAgICAgY2FzZSAkZnNfdHlwZSBpbgogICAgICAgICAgICB4ZnMpCiAgICAgICAgICAgICAgICB4ZnNfZ3Jvd2ZzIC8gfHwgewogICAgICAgICAgICAgICAgICAgIGVjaG8gIkZhaWxlZCB0byByZXNpemUgWEZTIGZpbGVzeXN0ZW0iCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDEKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIDs7CiAgICAgICAgICAgIGV4dDQpCiAgICAgICAgICAgICAgICByZXNpemUyZnMgJHtkZXZpY2V9MSB8fCB7CiAgICAgICAgICAgICAgICAgICAgZWNobyAiRmFpbGVkIHRvIHJlc2l6ZSBleHQ0IGZpbGVzeXN0ZW0iCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDEKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIDs7CiAgICAgICAgICAgICopCiAgICAgICAgICAgICAgICBlY2hvICJVbnN1cHBvcnRlZCBmaWxlc3lzdGVtOiAkZnNfdHlwZSIKICAgICAgICAgICAgICAgIHJldHVybiAxCiAgICAgICAgICAgICAgICA7OwogICAgICAgIGVzYWMKICAgIGZpCgogICAgZWNobyAiRUJTIHJlc2l6ZSBjb21wbGV0ZWQgc3VjY2Vzc2Z1bGx5IgogICAgcmV0dXJuIDAKfQoKIyBFeGVjdXRlIHJlc2l6ZQppZiAhIHJlc2l6ZV9lYnNfZm9yX2luc3RhbmNlOyB0aGVuCiAgICBlY2hvICJFQlMgcmVzaXplIGZhaWxlZCIKZmkKCiMgT1Mtc3BlY2lmaWMgYm9vdHN0cmFwCm9zX3R5cGU9JChkZXRlY3Rfb3MpCmlmIFsgIiRvc190eXBlIiA9ICJhbDIwMjMiIF07IHRoZW4KICAgIC91c3IvYmluL25vZGVhZG0gaW5pdApmaQo="
---
apiVersion: karpenter.sh/v1
kind: NodePool
metadata:
  name: dynamic-disk-volume-np
spec:
  disruption:
    consolidationPolicy: WhenEmptyOrUnderutilized
    consolidateAfter: 1m
  limits:
    cpu: 1k
    memory: 500Gi
  template:
    metadata:
      labels:
        intent: dynamic-disk-volume
    spec:
      nodeClassRef:
        group: karpenter.k8s.aws
        kind: EC2NodeClass
        name: dynamic-disk-volume-nc
      requirements:
      - key: karpenter.sh/capacity-type
        operator: In
        values:
        - spot
        - on-demand
      - key: kubernetes.io/os
        operator: In
        values:
        - linux
      - key: kubernetes.io/arch
        operator: In
        values:
        - amd64
      - key: karpenter.k8s.aws/instance-category
        operator: In
        values:
        - c
        - m
        - r